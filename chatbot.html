
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLC-g1 | Chatbot AI Văn Học</title>
    <link rel="icon" href="icon-light.png" type="image/png" id="favicon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* Reset và font chữ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #ff8c45;
            --secondary-color: #2c82c9;
            --accent-color: #ff5722;
            --bg-color: #ffffff;
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --footer-bg: #2c82c9;
            --footer-text: white;
            --gradient: linear-gradient(135deg, #ff8c45, #ff5722);
            --hero-gradient: linear-gradient(135deg, rgba(255, 140, 69, 0.85), rgba(44, 130, 201, 0.8));
            --sidebar-bg: #f8f9fa;
            --hover-color: #e9ecef;
        }
        
        .dark-mode {
            --primary-color: #80afd1;
            --secondary-color: #4caf50;
            --accent-color: #80afd1;
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --card-bg: #1e1e1e;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            --footer-bg: #1a1a1a;
            --footer-text: #f0f0f0;
            --gradient: linear-gradient(135deg, #80afd1, #4caf50);
            --hero-gradient: linear-gradient(135deg, rgba(128, 175, 209, 0.85), rgba(76, 175, 80, 0.8));
            --sidebar-bg: #1e1e1e;
            --hover-color: #2a2a2a;
        }
        
        body {
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: all 0.4s ease;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 140, 69, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1.2s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Header */
        header {
            background-color: var(--bg-color);
            box-shadow: var(--shadow);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all 0.4s ease;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .logo-text {
            margin-left: 12px;
            transition: all 0.3s ease;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            transition: transform 0.3s ease;
        }
        
        .logo:hover .logo-icon {
            transform: rotate(15deg);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: var(--gradient);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .slider-icons {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 8px;
            pointer-events: none;
        }
        
        .slider-icons i {
            font-size: 14px;
            color: white;
        }
        
        /* Navigation */
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 2rem;
            position: relative;
        }
        
        nav ul li a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            padding: 8px 0;
            position: relative;
        }
        
        nav ul li a:hover {
            color: var(--primary-color);
        }
        
        nav ul li a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gradient);
            transition: width 0.3s ease;
        }
        
        nav ul li a:hover::after {
            width: 100%;
        }
        
        nav ul li a i {
            margin-right: 8px;
            font-size: 1.1rem;
        }
        
        .menu-toggle, .sidebar-toggle {
            display: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--primary-color);
            background: none;
            border: none;
        }
        
        /* Chatbot Styles */
        .app-container {
            display: flex;
            height: calc(100vh - 80px);
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.4s ease;
        }
        
        .sidebar-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .chat-item {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-item:hover {
            background-color: var(--hover-color);
        }
        
        .chat-item.active {
            background-color: var(--hover-color);
        }
        
        .chat-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .chat-date {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .delete-chat-btn {
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.7;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .delete-chat-btn:hover {
            opacity: 1;
            background-color: rgba(255, 0, 0, 0.1);
            color: #ff4444;
        }
        
        .sidebar-footer {
            padding: 1rem;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .user-message {
            align-self: flex-end;
            background: var(--gradient);
            color: white;
            border-radius: 18px 18px 4px 18px;
            padding: 12px 16px;
            max-width: 70%;
            box-shadow: var(--shadow);
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 18px 18px 18px 4px;
            padding: 12px 16px;
            max-width: 70%;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .typing-indicator {
            align-self: flex-start;
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 18px 18px 18px 4px;
            padding: 12px 16px;
            max-width: 70%;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .suggestions-bar {
            padding: 0.5rem 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .suggestions-title {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }
        
        .suggestions-container {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .suggestion-chip {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .suggestion-chip:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .input-area {
            padding: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .chat-form {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 24px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: var(--card-bg);
            color: var(--text-color);
            resize: none;
            min-height: 48px;
            max-height: 120px;
            transition: all 0.3s ease;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(255, 140, 69, 0.2);
        }
        
        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .send-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Markdown Styles */
        .markdown p {
            margin-bottom: 0.5rem;
        }
        
        .markdown ul, .markdown ol {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
        }
        
        .markdown li {
            margin-bottom: 0.25rem;
        }
        
        .markdown code:not(pre code) {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .markdown strong {
            font-weight: 600;
        }
        
        .markdown em {
            font-style: italic;
        }
        
        .markdown h1, .markdown h2, .markdown h3, .markdown h4 {
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .markdown h1 {
            font-size: 1.5rem;
        }
        
        .markdown h2 {
            font-size: 1.25rem;
        }
        
        .markdown h3 {
            font-size: 1.125rem;
        }
        
        .markdown h4 {
            font-size: 1rem;
        }
        
        .markdown blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .code-block {
            position: relative;
            margin: 0.5rem 0;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--sidebar-bg);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: rgba(0, 0, 0, 0.05);
            font-family: monospace;
            font-size: 0.8rem;
        }
        
        .copy-code-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .copy-code-btn:hover {
            color: var(--primary-color);
        }
        
        pre {
            margin: 0 !important;
            padding: 1rem !important;
            overflow-x: auto;
        }
        
        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            z-index: 20;
            background-color: var(--primary-color);
            color: white;
            width: 30px;
            height: 50px;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .sidebar-toggle:hover {
            background-color: var(--accent-color);
            transform: translateY(-50%) scale(1.1);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .menu-toggle, .sidebar-toggle {
                display: flex;
            }
            
            nav {
                position: absolute;
                top: 70px;
                left: 0;
                width: 100%;
                background-color: var(--bg-color);
                padding: 1rem;
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
                display: none;
                border-radius: 0 0 10px 10px;
            }
            
            nav.active {
                display: block;
            }
            
            nav ul {
                flex-direction: column;
            }
            
            nav ul li {
                margin: 0.8rem 0;
            }
            
            .sidebar {
                position: absolute;
                left: -250px;
                top: 0;
                height: 100%;
                z-index: 10;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .user-message, .bot-message {
                max-width: 85%;
            }
            
            /* Ẩn chữ "Hỗ Trợ Văn Học" trên thanh menu khi màn hình nhỏ */
            .logo-text {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .user-message, .bot-message {
                max-width: 90%;
            }
            
            .suggestions-container {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Đang tải Hỗ Trợ Văn Học...</div>
    </div>
    
    <!-- Header với navigation -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="icon-light.png" alt="Hỗ Trợ Văn Học" class="logo-icon" id="logoIcon">
                    <span class="logo-text">Hỗ Trợ Văn Học</span>
                </div>
                <div class="header-controls">
                    <label class="theme-switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                        <div class="slider-icons">
                            <i class="fas fa-sun"></i>
                            <i class="fas fa-moon"></i>
                        </div>
                    </label>
                    <button class="menu-toggle"><i class="fas fa-bars"></i></button>
                </div>
                <nav id="main-nav">
                    <ul>
                        <li><a href="index.html"><i class="fas fa-home"></i>Trang chủ</a></li>
                        <li><a href="phantich.html"><i class="fas fa-pen-fancy"></i>Phân tích văn học</a></li>
                        <li><a href="bando.html"><i class="fas fa-map-marked-alt"></i>Bản đồ</a></li>
                        <li><a href="chatbot.html" class="active"><i class="fas fa-robot"></i>Chatbot AI</a></li>
                        <li><a href="thithu.html"><i class="fas fa-edit"></i>Thi thử</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-chevron-right"></i>
    </button>
    
    <!-- Chatbot App -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button id="new-chat-btn" class="new-chat-btn">
                    <i class="fas fa-file-circle-plus"></i>
                    <span>Đoạn nhắn mới</span>
                </button>
                <button class="sidebar-toggle mobile-only" id="mobileSidebarToggle">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-history" id="chat-history">
                <!-- Chat history will be populated here -->
            </div>
            
            <div class="sidebar-footer">
                <p>©2025 THPT Thừa Lưu</p>
                <p>Hoàng Minh Tuấn & Trương Viết Duy Chương</p>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-messages" id="chat-messages">
                <!-- Messages will appear here -->
            </div>
            
            <div class="suggestions-bar" id="suggestions-bar" style="display: none;">
                <div class="suggestions-title">Gợi ý:</div>
                <div class="suggestions-container" id="suggestions-container">
                    <!-- Suggested questions will appear here -->
                </div>
            </div>
            
            <div class="input-area">
                <form id="chat-form" class="chat-form">
                    <textarea 
                        id="message-input" 
                        class="message-input"
                        placeholder="Nhập câu hỏi về văn học..."
                        rows="1"
                    ></textarea>
                    <button 
                        id="send-button" 
                        type="submit" 
                        class="send-button"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const API_KEY = "AIzaSyAQMglgiKEHY8XznNf9ZIdjYMnKgH9DhJg";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistory = document.getElementById('chat-history');
        const sendButton = document.getElementById('send-button');
        const menuToggle = document.querySelector('.menu-toggle');
        const mainNav = document.getElementById('main-nav');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const suggestionsBar = document.getElementById('suggestions-bar');
        const suggestionsContainer = document.getElementById('suggestions-container');

        let chats = [];
        let currentChatId = null;
        let isSending = false;
        let typingInterval = null;
        let isStopped = false;
        let isSidebarVisible = true;

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const favicon = document.getElementById('favicon');
        const logoIcon = document.getElementById('logoIcon');
        
        // Kiểm tra theme đã lưu trong localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.checked = true;
            favicon.href = 'icon-dark.png';
            logoIcon.src = 'icon-dark.png';
        } else {
            favicon.href = 'icon-light.png';
            logoIcon.src = 'icon-light.png';
        }
        
        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                favicon.href = 'icon-dark.png';
                logoIcon.src = 'icon-dark.png';
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                favicon.href = 'icon-light.png';
                logoIcon.src = 'icon-light.png';
            }
        });

        // Menu toggle for mobile
        menuToggle.addEventListener('click', function() {
            mainNav.classList.toggle('active');
        });

        // Sidebar toggle
        sidebarToggle.addEventListener('click', function() {
            isSidebarVisible = !isSidebarVisible;
            toggleSidebar();
        });

        // Mobile sidebar toggle
        mobileSidebarToggle.addEventListener('click', function() {
            isSidebarVisible = false;
            toggleSidebar();
        });

        function toggleSidebar() {
            if (isSidebarVisible) {
                sidebar.style.left = '0';
                sidebarToggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
            } else {
                sidebar.style.left = '-250px';
                sidebarToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
        }

        // Close menu when clicking on a link (for mobile)
        const navLinks = document.querySelectorAll('nav ul li a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                mainNav.classList.remove('active');
            });
        });

        // Literary Keywords for filtering
        const literaryKeywords = [
            "văn học", "tác phẩm", "nhà văn", "thơ", "truyện", "tác giả", "chào", "là ai", 
            "tiểu thuyết", "chào", "bởi ai", "cảm hứng", "viết", "chữ", "từ", "câu", 
            "tóm tắt", "trình bầy", "tạo", "hoàn thiện", "văn", "trích", "nguồn gốc", 
            "từ", "văn","thơ","truyện","ca dao","tục ngữ","nhân vật","tác giả",
            "tác phẩm","thời kỳ","văn học","thơ ca","truyện ngắn","tiểu thuyết",
            "kịch","văn xuôi","lục bát","tự do","Đường luật","thơ mới","thơ cổ",
            "hiện đại","trữ tình","trào phúng","chữ Hán","chữ Nôm","chữ Quốc ngữ",
            "dân gian","cung đình","cách mạng","kháng chiến","hậu chiến","đương đại",
            "nước ngoài","thi pháp","ngôn ngữ","hình tượng","bút pháp","chủ đề",
            "tư tưởng","nghệ thuật","phong cách","vần đạo","thiền","tình yêu",
            "quê hương","chiến tranh","hòa bình","lịch sử","văn hóa","xã hội",
            "nhân đạo","hiện thực","lãng mạn","bi kịch","hài kịch","anh hùng",
            "phản diện","tâm lý","triết lý","tượng trưng","siêu thực","cổ điển",
            "hiện đại","hậu hiện đại","trung đại","cận đại","phục hưng","khai sáng",
            "lãng mạn","tự sự","trữ tình","tả thực","ẩn dụ","hoán dụ","nhân hóa",
            "so sánh","điệp ngữ","ẩn ý","tứ thơ","vần điệu","nhịp điệu","câu thơ",
            "đoạn thơ","bài thơ","tập thơ","tuyển tập","văn bản","bản dịch",
            "nguyên tác","tác phẩm kinh điển","tác phẩm tiêu biểu","tác phẩm nổi tiếng",
            "tác phẩm văn học","tác phẩm nghệ thuật","tác phẩm văn hóa",
            "tác phẩm lịch sử","tác phẩm triết học","tác phẩm tôn giáo",
            "tác phẩm chính trị","tác phẩm xã hội","tác phẩm nhân văn",
            "tác phẩm khoa học","tác phẩm giáo dục","tác phẩm văn minh"
        ];

        function isLiteraryQuestion(question) {
            const lowerQuestion = question.toLowerCase();
            return literaryKeywords.some(keyword => lowerQuestion.includes(keyword.toLowerCase()));
        }

        function generateSuggestions(messages) {
            const userMessages = messages.filter(msg => msg.role === "user");
            if (userMessages.length === 0) {
                return [
                    "Phân tích bài thơ 'Đây thôn Vĩ Dạ' của Hàn Mặc Tử",
                    "Kể tên các tác phẩm tiêu biểu của Nam Cao",
                    "Giới thiệu về phong trào Thơ mới 1932-1945",
                    "Phân tích nhân vật Chí Phèo trong tác phẩm cùng tên"
                ];
            }
            
            // Simple logic to generate follow-up questions based on previous messages
            const lastMessage = userMessages[userMessages.length - 1].content;
            
            if (lastMessage.includes("phân tích")) {
                return [
                    "Bạn có thể phân tích sâu hơn về nghệ thuật trong tác phẩm này không?",
                    "Tác giả sử dụng những biện pháp tu từ nào?",
                    "Ý nghĩa nhan đề của tác phẩm là gì?"
                ];
            } else if (lastMessage.includes("tác giả")) {
                return [
                    `Các tác phẩm khác của ${lastMessage.split(" ")[0]}`,
                    "Phong cách sáng tác của tác giả này",
                    "Ảnh hưởng của tác giả này đến văn học Việt Nam"
                ];
            } else if (lastMessage.includes("thơ")) {
                return [
                    "Phân tích hình ảnh trong bài thơ",
                    "Bố cục của bài thơ này như thế nào?",
                    "Hoàn cảnh sáng tác bài thơ này"
                ];
            }
            
            return [
                "Bạn có thể giải thích rõ hơn về điều này không?",
                "Có tác phẩm nào tương tự như vậy không?",
                "Ý nghĩa sâu xa của vấn đề này là gì?"
            ];
        }

        function initApp() {
            loadChats();
            setupEventListeners();
            setupTextareaAutoResize();

            if (chats.length === 0) {
                createNewChat();
            } else {
                loadChat(chats[0].id);
            }
        }

        function setupEventListeners() {
            chatForm.addEventListener('submit', handleSubmit);
            messageInput.addEventListener('input', autoResizeTextarea);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (messageInput.value.trim() !== '') {
                        chatForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
            newChatBtn.addEventListener('click', createNewChat);
        }

        function setupTextareaAutoResize() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 120);
            messageInput.style.height = `${newHeight}px`;
        }

        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 120);
            messageInput.style.height = `${newHeight}px`;
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage || isSending) return;

            if (!isLiteraryQuestion(userMessage)) {
                addMessageToUI("assistant", "Xin lỗi, tôi chỉ trả lời chuyên về các câu hỏi liên quan đến văn học, bạn có câu hỏi nào liên quan đến văn học mà muốn hỏi tôi không?");
                messageInput.value = "";
                autoResizeTextarea();
                return;
            }

            if (!currentChatId) {
                createNewChat();
                return;
            }

            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!currentChat) {
                console.error("Không tìm thấy cuộc trò chuyện hiện tại!");
                return;
            }

            isSending = true;
            addMessageToUI("user", userMessage);
            
            // Change send button to stop button
            sendButton.innerHTML = '<div class="loading-spinner"></div>';
            sendButton.disabled = true;

            const greetings = ["chào", "hello"];
            if (greetings.some(greet => userMessage.toLowerCase().includes(greet))) {
                const greetingResponse = "Xin chào, tôi là AI văn học được tạo ra bởi Hoàng Minh Tuấn và Trương Viết Duy Chương đến từ trường THPT Thừa Lưu. Tôi có thể giúp gì cho bạn về văn học ngay bây giờ?";
                displayTypingMessage(greetingResponse, () => {
                    if (!isStopped) {
                        currentChat.messages.push({ 
                            role: "assistant", 
                            content: greetingResponse,
                            timestamp: new Date().toISOString()
                        });
                        saveChats();
                        updateSuggestions(currentChat.messages);
                    }
                });
                messageInput.value = "";
                autoResizeTextarea();
                isSending = false;
                resetSendButton();
                return;
            }

            currentChat.messages.push({ 
                role: "user", 
                content: userMessage,
                timestamp: new Date().toISOString()
            });

            saveChats();
            updateChatTitle(currentChat);

            messageInput.value = "";
            autoResizeTextarea();
            isStopped = false;

            try {
                const chatSession = model.startChat({
                    history: currentChat.messages.map(msg => ({
                        role: msg.role === "user" ? "user" : "model",
                        parts: [{ text: msg.content }]
                    })),
                    generationConfig: {
                        maxOutputTokens: 2000,
                        temperature: 0.9,
                        topP: 0.1,
                        topK: 16,
                    }
                });

                const result = await chatSession.sendMessage(userMessage);
                const response = await result.response;
                const botReply = response.text();

                // Giới hạn câu trả lời tối đa 250 từ
                const limitedReply = limitWords(botReply, 250);
                
                displayTypingMessage(limitedReply, () => {
                    if (!isStopped) {
                        currentChat.messages.push({ 
                            role: "assistant", 
                            content: limitedReply,
                            timestamp: new Date().toISOString()
                        });
                        saveChats();
                        updateSuggestions(currentChat.messages);
                    }
                });
            } catch (error) {
                console.error("Lỗi: ", error);
                addMessageToUI("assistant", "Lỗi kết nối 221!");
            } finally {
                isSending = false;
                resetSendButton();
                scrollToBottom();
            }
        }

        // Hàm giới hạn số từ trong câu trả lời
        function limitWords(text, maxWords) {
            const words = text.split(' ');
            if (words.length <= maxWords) {
                return text;
            }
            
            const limitedWords = words.slice(0, maxWords);
            return limitedWords.join(' ') + '...';
        }

        function resetSendButton() {
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendButton.disabled = false;
        }

        function updateSuggestions(messages) {
            const suggestions = generateSuggestions(messages);
            suggestionsContainer.innerHTML = '';
            
            if (suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const chip = document.createElement('div');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.addEventListener('click', () => {
                        messageInput.value = suggestion;
                        messageInput.focus();
                        autoResizeTextarea();
                    });
                    suggestionsContainer.appendChild(chip);
                });
                suggestionsBar.style.display = 'block';
            } else {
                suggestionsBar.style.display = 'none';
            }
        }

        function displayTypingMessage(content, callback) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'typing-indicator';
            messageDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span>AI đang suy nghĩ, vui lòng đợi giây lát</span>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            setTimeout(() => {
                messageDiv.remove();
                addMessageToUI("assistant", content);
                if (callback) callback();
            }, 1500);
        }

        function addMessageToUI(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'user-message' : 'bot-message';
            
            const formattedContent = formatMessage(content);
            messageDiv.innerHTML = `<div class="markdown">${formattedContent}</div>`;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function formatMessage(content) {
            if (!content) return '';

            let formatted = content.replace(/```([\w]*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const langDisplay = lang ? lang : 'text';
                return `<div class="code-block">
                    <div class="code-header">
                        <span>${langDisplay}</span>
                        <button class="copy-code-btn" onclick="copyToClipboard(this)" data-code="${encodeURIComponent(code.trim())}">
                            <i class="fas fa-copy"></i> Copy code
                        </button>
                    </div>
                    <pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>
                </div>`;
            });

            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            formatted = formatted.split('\n\n').map(paragraph => {
                if (paragraph.trim().startsWith('<') && paragraph.trim().endsWith('>')) {
                    return paragraph;
                }
                return `<p>${paragraph}</p>`;
            }).join('');

            formatted = formatted.replace(/\n(?![<])/g, '<br>');

            return formatted;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'Đoạn nhắn mới',
                messages: [],
                createdAt: new Date().toISOString()
            };

            chats.unshift(newChat);
            saveChats();
            renderChatHistory();
            loadChat(newChat.id);
            
            messageInput.focus();
            suggestionsBar.style.display = 'none';
        }

        function loadChat(chatId) {
            currentChatId = chatId;

            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.dataset.id === chatId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            chatMessages.innerHTML = '';

            const currentChat = chats.find(chat => chat.id === chatId);
            if (!currentChat) return;

            if (currentChat.messages.length > 0) {
                currentChat.messages.forEach(message => {
                    addMessageToUI(message.role, message.content);
                });
                updateSuggestions(currentChat.messages);
            } else {
                suggestionsBar.style.display = 'none';
            }
            
            scrollToBottom();
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            chats = chats.filter(chat => chat.id !== chatId);
            saveChats();
            renderChatHistory();

            if (chatId === currentChatId) {
                if (chats.length > 0) {
                    loadChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
        }

        function updateChatTitle(chat) {
            if (!chat || !chat.messages || chat.messages.length === 0) {
                chat.title = "Đoạn nhắn mới";
                saveChats();
                renderChatHistory();
                return;
            }

            const firstUserMessage = chat.messages.find(msg => msg.role === "user");
            if (firstUserMessage) {
                let title = firstUserMessage.content.substring(0, 40);
                if (firstUserMessage.content.length > 40) {
                    title += "...";
                }
                chat.title = title || "Đoạn nhắn mới";
            } else {
                chat.title = "Đoạn nhắn mới";
            }

            saveChats();
            renderChatHistory();
        }

        function renderChatHistory() {
            chatHistory.innerHTML = '';

            if (chats.length === 0) {
                chatHistory.innerHTML = `
                    <div class="text-center p-4" style="color: var(--text-color); opacity: 0.7;">
                        Chưa có đoạn nhắn nào
                    </div>
                `;
                return;
            }

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                chatItem.dataset.id = chat.id;

                const chatDate = new Date(chat.createdAt || chat.id);
                const formattedDate = chatDate.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                chatItem.innerHTML = `
                    <div class="chat-title">${chat.title || 'Đoạn nhắn mới'}</div>
                    <div class="chat-date">${formattedDate}</div>
                    <button class="delete-chat-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                `;

                chatItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat-btn')) {
                        loadChat(chat.id);
                    }
                });

                const deleteBtn = chatItem.querySelector('.delete-chat-btn');
                deleteBtn.addEventListener('click', (e) => {
                    deleteChat(chat.id, e);
                });

                chatHistory.appendChild(chatItem);
            });
        }

        function loadChats() {
            const storedChats = localStorage.getItem('tlc-g1-chats');
            if (storedChats) {
                const now = Date.now();
                const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

                chats = JSON.parse(storedChats)
                    .filter(chat => now - new Date(chat.createdAt || chat.id).getTime() < THIRTY_DAYS)
                    .sort((a, b) => new Date(b.createdAt || b.id) - new Date(a.createdAt || a.id));
                
                saveChats();
                renderChatHistory();
            }
        }

        function saveChats() {
            const now = Date.now();
            const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

            chats = chats.filter(chat => {
                const chatTime = new Date(chat.createdAt || chat.id).getTime();
                return now - chatTime < THIRTY_DAYS;
            });

            localStorage.setItem('tlc-g1-chats', JSON.stringify(chats));
        }

        function copyToClipboard(button) {
            const code = decodeURIComponent(button.getAttribute('data-code'));
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }

        window.addEventListener("beforeunload", () => {
            chats = chats.filter(chat => chat.messages.length > 0);
            saveChats();
        });

        // Loading Screen
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1200);
        });

        document.addEventListener('DOMContentLoaded', initApp);
        
        window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>
