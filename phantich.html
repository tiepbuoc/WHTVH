<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phân tích thơ, ca dao, tục ngữ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .analysis-section {
            background-color: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
            margin-top: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .tone-markers {
            font-family: monospace;
            font-weight: bold;
        }
        .tone-T {
            color: #ef4444;
        }
        .tone-B {
            color: #10b981;
        }
        .law-result {
            font-weight: bold;
            font-size: 1.1rem;
            color: #1d4ed8;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Phân tích thơ, ca dao, tục ngữ</h2>
        
        <textarea id="inputText" class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none" placeholder="Nhập nội dung văn bản..."></textarea>
        <button onclick="analyzeText()" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Phân tích</button>
        <div id="result" class="mt-6 text-gray-700"></div>
    </div>

    <script>
        const GEMINI_CONFIG = {
            apiKey: 'AIzaSyAQMglgiKEHY8XznNf9ZIdjYMnKgH9DhJg',
            model: 'gemini-2.5-flash-preview-05-20'
        };

        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        function parseMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                .replace(/\n/g, '<br>');
        }

        function verifyAIOutput(type, inputText, aiOutput) {
            let correctedOutput = aiOutput;

            if (type === 'contentAnalysis' || type === 'artisticAnalysis') {
                const sections = aiOutput.split('<br>').filter(line => line.includes('<strong'));
                const expectedSections = type === 'contentAnalysis' ? 
                    ['Ý nghĩa', 'Cảm xúc', 'Chủ đề chính'] : 
                    ['Biện pháp tu từ', 'Nhịp điệu', 'Hình ảnh', 'Cách gieo vần'];

                const missingSections = expectedSections.filter(section => 
                    !sections.some(line => line.includes(section))
                );

                if (missingSections.length > 0) {
                    correctedOutput += `<br><strong>Thiếu mục:</strong> ${missingSections.join(', ')} (đã bổ sung thông báo).`;
                }
            }

            return correctedOutput;
        }

        function xacDinhNhanVatTruTinh(baiTho) {
            let tuTrongBaiTho = baiTho.split(/\s+/);
            
            if (tuTrongBaiTho.includes("tôi") || tuTrongBaiTho.includes("Tôi")) {
                return "Nhân vật trữ tình là: Tôi";
            }
            if (tuTrongBaiTho.includes("cha")) {
                return "Nhân vật trữ tình là: Cha";
            }
            
            let tuDauCau = baiTho.split('\n').map(cau => cau.trim().split(/\s+/)[0]);
            let tuCanTim = ["Anh", "Em", "Con", "Cháu", "Ta", "anh", "em", "con", "cháu", "ta"];
            let demTu = {};
            
            tuDauCau.forEach(tu => {
                if (tuCanTim.includes(tu)) {
                    demTu[tu] = (demTu[tu] || 0) + 1;
                }
            });
            
            let nhanVatTruTinh = "Tác giả";
            let maxXuatHien = 0;
            
            for (let tu in demTu) {
                if (demTu[tu] > maxXuatHien) {
                    maxXuatHien = demTu[tu];
                    nhanVatTruTinh = tu;
                }
            }
            
            return "Nhân vật trữ tình là: " + nhanVatTruTinh;
        }

        function removeVietnameseAccents(str) {
            const accentMap = {
                'á': 'a', 'à': 'a', 'ả': 'a', 'ã': 'a', 'ạ': 'a',
                'â': 'a', 'ầ': 'a', 'ấ': 'a', 'ẩ': 'a', 'ẫ': 'a', 'ậ': 'a',
                'ă': 'a', 'ằ': 'a', 'ắ': 'a', 'ẳ': 'a', 'ẵ': 'a', 'ặ': 'a',
                'é': 'e', 'è': 'e', 'ẻ': 'e', 'ẽ': 'e', 'ẹ': 'e',
                'ê': 'e', 'ế': 'e', 'ề': 'e', 'ể': 'e', 'ễ': 'e', 'ệ': 'e',
                'í': 'i', 'ì': 'i', 'ỉ': 'i', 'ĩ': 'i', 'ị': 'i',
                'ó': 'o', 'ò': 'o', 'ỏ': 'o', 'õ': 'o', 'ọ': 'o',
                'ô': 'o', 'ố': 'o', 'ồ': 'o', 'ổ': 'o', 'ỗ': 'o', 'ộ': 'o',
                'ơ': 'o', 'ớ': 'o', 'ờ': 'o', 'ở': 'o', 'ỡ': 'o', 'ợ': 'o',
                'ú': 'u', 'ù': 'u', 'ủ': 'u', 'ũ': 'u', 'ụ': 'u',
                'ư': 'u', 'ứ': 'u', 'ừ': 'u', 'ử': 'u', 'ữ': 'u', 'ự': 'u',
                'ý': 'y', 'ỳ': 'y', 'ỷ': 'y', 'ỹ': 'y', 'ỵ': 'y',
            };
            return str.split('').map(c => accentMap[c] || c).join('');
        }

        function removePunctuation(str) {
            return str.replace(/[.,'!?)(}{|:;><~`@#$%^&*-_+=]/g, '');
        }

        const rhymePatterns = [
            "iêu", "an", "ang", "o", "a", "on", "ôn", "ôi", "oa", "ao", "i", "u", "e", "ê", "uê", "y", "un",
            "oc", "ot", "iêu", "on", "ie", "ư", "ưn", "uy", "am", "ap", "em", "ep", "im", "ip", "um", "up",
            "ic", "oc", "it", "ot", "ut", "inh", "ang", "ong", "ing", "ong", "oi", "em", "ep", "im", "ip",
            "um", "up", "it", "ut", "ic", "oc", "ông", "ung", "ing", "eu", "au", "uy", "uan", "ơp", "op",
            "ân", "ă", "ê", "ơ", "ai", "iê", "ia", "ua", "ay", "ơi", "ua", "ie", "iu", "ơm", "au", "â", "ô",
            "ư", "i", "y", "ai", "eo", "êu", "ui", "ung", "inh", "ieu", "oay", "at", "ac", "enh", "en", "uoc"
        ];

        function getLastRhyme(word) {
            const wordWithoutAccents = removeVietnameseAccents(removePunctuation(word)).toLowerCase();

            const sortedRhymePatterns = rhymePatterns.sort((a, b) => {
                if (b.length !== a.length) {
                    return b.length - a.length;
                }
                return rhymePatterns.indexOf(a) - rhymePatterns.indexOf(b);
            });

            for (let rhyme of sortedRhymePatterns) {
                if (wordWithoutAccents.endsWith(rhyme)) {
                    return rhyme;
                }
            }

            return wordWithoutAccents.charAt(wordWithoutAccents.length - 1);
        }

        function analyzeRhymeAndTone(poem) {
            const lines = poem.split(/\n+/).filter(line => line.trim() !== '');
            let resultDiv = document.getElementById('result');
            
            const rhymeAnalysis = {};
            lines.forEach((line, index) => {
                const words = line.split(' ').filter(word => word.length > 0);
                const lowerCaseWords = words.map(word => word.toLowerCase());

                if (lowerCaseWords.length === 4) {
                    const secondWord = removePunctuation(lowerCaseWords[1]);
                    const secondRhyme = getLastRhyme(secondWord);
                    if (secondRhyme && secondRhyme !== '') {
                        if (!rhymeAnalysis[secondRhyme]) {
                            rhymeAnalysis[secondRhyme] = [];
                        }
                        rhymeAnalysis[secondRhyme].push({ word: words[1], line: index + 1, type: 'second' });
                    }

                    const lastWord = removePunctuation(lowerCaseWords[3]);
                    const lastRhyme = getLastRhyme(lastWord);
                    if (lastRhyme && lastRhyme !== '') {
                        if (!rhymeAnalysis[lastRhyme]) {
                            rhymeAnalysis[lastRhyme] = [];
                        }
                        rhymeAnalysis[lastRhyme].push({ word: words[3], line: index + 1, type: 'last' });
                    }
                }
                else {
                    if (lowerCaseWords.length === 7) {
                        const fifthWord = removePunctuation(lowerCaseWords[4]);
                        const fifthRhyme = getLastRhyme(fifthWord);
                        if (fifthRhyme && fifthRhyme !== '') {
                            if (!rhymeAnalysis[fifthRhyme]) {
                                rhymeAnalysis[fifthRhyme] = [];
                            }
                            rhymeAnalysis[fifthRhyme].push({ word: words[4], line: index + 1, type: 'fifth' });
                        }
                    }

                    if (lowerCaseWords.length === 8) {
                        const fourthWord = removePunctuation(lowerCaseWords[3]);
                        const fourthRhyme = getLastRhyme(fourthWord);
                        if (fourthRhyme && fourthRhyme !== '') {
                            if (!rhymeAnalysis[fourthRhyme]) {
                                rhymeAnalysis[fourthRhyme] = [];
                            }
                            rhymeAnalysis[fourthRhyme].push({ word: words[3], line: index + 1, type: 'fourth' });
                        }

                        const sixthWord = removePunctuation(lowerCaseWords[5]);
                        const sixthRhyme = getLastRhyme(sixthWord);
                        if (sixthRhyme && sixthRhyme !== '') {
                            if (!rhymeAnalysis[sixthRhyme]) {
                                rhymeAnalysis[sixthRhyme] = [];
                            }
                            rhymeAnalysis[sixthRhyme].push({ word: words[5], line: index + 1, type: 'sixth' });
                        }
                    }

                    const lastWord = removePunctuation(lowerCaseWords[lowerCaseWords.length - 1]);
                    const lastRhyme = getLastRhyme(lastWord);
                    if (lastRhyme && lastRhyme !== '') {
                        if (!rhymeAnalysis[lastRhyme]) {
                            rhymeAnalysis[lastRhyme] = [];
                        }
                        rhymeAnalysis[lastRhyme].push({ word: words[words.length - 1], line: index + 1, type: 'last' });
                    }
                }
            });

            let rhymeResultHtml = '<div class="analysis-section"><h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-music mr-2"></i> Phân tích vần điệu</h3>';
            let foundRhyme = false;

            for (const rhyme in rhymeAnalysis) {
                if (rhymeAnalysis[rhyme].length > 1) {
                    foundRhyme = true;
                    rhymeResultHtml += `<p class="font-medium text-gray-700 mt-2">Vần <span class="font-bold">"${rhyme}"</span>:</p><ul class="list-disc pl-5">`;
                    rhymeAnalysis[rhyme].forEach(item => {
                        let wordType = item.type === 'last' ? 'từ cuối' : 
                                      item.type === 'sixth' ? 'từ thứ 6' : 
                                      item.type === 'fourth' ? 'từ thứ 4' : 
                                      item.type === 'fifth' ? 'từ thứ 5' : 'từ thứ 2';
                        rhymeResultHtml += `<li class="text-gray-600">Từ <span class="font-medium">"${item.word}"</span> ở dòng ${item.line} (${wordType})</li>`;
                    });
                    rhymeResultHtml += '</ul>';
                }
            }

            if (!foundRhyme) {
                rhymeResultHtml = '<p class="text-red-500">Không tìm thấy các từ được gieo vần với nhau trong bài thơ.</p>';
            }
            rhymeResultHtml += '</div>';
            
            let toneResult = [];
            let bangCount = 0;
            let tracCount = 0;

            lines.forEach((line, index) => {
                let words = line.trim().split(/\s+/);
                let lineResult = words.map(word => {
                    let mainVowels = word.split('').filter(char => 'áàảãạắằẳẵặấầẩẫậéèẻẽẹểễếệứửữựíìỉĩịóòỏõọốồổỗộớờởợỡúùủũụýỳỷỹỵ'.includes(char));
                   
                    let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                    if (tone === "B") bangCount++;
                    if (tone === "T") tracCount++;
                    return tone;
                });

                toneResult.push(`Dòng ${index + 1}: ${lineResult.join(' ')}`);
            });

            let toneResultHtml = `<div class="analysis-section"><h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-wave-square mr-2"></i> Phân tích vần trắc (T) và vần bằng (B)</h3>`;
            toneResultHtml += toneResult.map(line => {
                line = line.replace(/(T)/g, '<span class="tone-T">$1</span>');
                line = line.replace(/(B)/g, '<span class="tone-B">$1</span>');
                return `<p class="text-gray-600 tone-markers">${line}</p>`;
            }).join('');

            // Analyze tone ratio and add result
            let toneAnalysisHtml = '';
            if (bangCount > 0 && tracCount > 0) {
                if (bangCount > tracCount) {
                    let ratio = bangCount / tracCount;
                    if (ratio >= 1.5) {
                        toneAnalysisHtml = `<p class="text-gray-600 font-bold mt-2">Bài thơ có âm điệu nhẹ nhàng, du dương.</p>`;
                    } else {
                        toneAnalysisHtml = `<p class="text-gray-600 font-bold mt-2">Bài thơ có âm điệu hài hòa, trầm bỗng.</p>`;
                    }
                } else {
                    let ratio = tracCount / bangCount;
                    if (ratio >= 1.5) {
                        toneAnalysisHtml = `<p class="text-gray-600 font-bold mt-2">Bài thơ có âm điệu mạnh mẽ, hùng hồn.</p>`;
                    } else {
                        toneAnalysisHtml = `<p class="text-gray-600 font-bold mt-2">Bài thơ có âm điệu hài hòa, trầm bỗng.</p>`;
                    }
                }
            } else {
                toneAnalysisHtml = `<p class="text-gray-600 font-bold mt-2">Bài thơ có âm điệu hài hòa, trầm bỗng.</p>`;
            }
            toneResultHtml += toneAnalysisHtml;
            toneResultHtml += '</div>';
            
            const nhanVatTruTinh = xacDinhNhanVatTruTinh(poem);
            let characterHtml = `<div class="analysis-section"><h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-user mr-2"></i> Nhân vật trữ tình</h3>`;
            characterHtml += `<p class="text-gray-600">${nhanVatTruTinh}</p></div>`;
            
            let lawResult = checkDuongLuat(lines);
            let lawHtml = '';
            if (lawResult) {
                lawHtml = `<div class="analysis-section"><h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-gavel mr-2"></i> Kiểm tra luật thơ Đường</h3>`;
                lawHtml += `<p class="law-result">${lawResult}</p></div>`;
            }
            
            resultDiv.innerHTML += characterHtml + rhymeResultHtml + toneResultHtml + lawHtml;
        }

        function checkDuongLuat(lines) {
            const lineWordCounts = lines.map(line => line.split(/\s+/).filter(word => word.trim() !== "").length);
            const totalLines = lines.length;
            
            if (lineWordCounts.every(count => count === 7) && totalLines === 8) {
                const ruleBy = [
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"]
                ];
                const ruleTrac = [
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"]
                ];
           
                let isMatchBy = true;
                let isMatchTrac = true;
                
                lines.forEach((line, index) => {
                    let words = line.trim().split(/\s+/);
                    let positionsToCheck = [1, 3, 5];
           
                    let lineCheckBy = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleBy[index][i];
                    });
                    
                    let lineCheckTrac = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleTrac[index][i];
                    });
           
                    if (!lineCheckBy) isMatchBy = false;
                    if (!lineCheckTrac) isMatchTrac = false;
                });
                
                if (isMatchBy) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần bằng)";
                } else if (isMatchTrac) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần trắc)";
                } else {
                    return "Bài thơ không tuân theo luật thơ Đường";
                }
            } else if (lineWordCounts.every(count => count === 7) && totalLines === 4) {
                const ruleBy = [
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"]
                ];
                const ruleTrac = [
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"]
                ];
                
                let isMatchBy = true;
                let isMatchTrac = true;
                
                lines.forEach((line, index) => {
                    let words = line.trim().split(/\s+/);
                    let positionsToCheck = [1, 3, 5];
           
                    let lineCheckBy = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleBy[index][i];
                    });
                    
                    let lineCheckTrac = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleTrac[index][i];
                    });
           
                    if (!lineCheckBy) isMatchBy = false;
                    if (!lineCheckTrac) isMatchTrac = false;
                });
                
                if (isMatchBy) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần bằng)";
                } else if (isMatchTrac) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần trắc)";
                } else {
                    return "Bài thơ không tuân theo luật thơ Đường";
                }
            } else if (lineWordCounts.every(count => count === 5) && totalLines === 8) {
                const ruleBy = [
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"]
                ];
                const ruleTrac = [
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"]
                ];
                
                let isMatchBy = true;
                let isMatchTrac = true;
                
                lines.forEach((line, index) => {
                    let words = line.trim().split(/\s+/);
                    let positionsToCheck = [1, 3];
           
                    let lineCheckBy = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleBy[index][i];
                    });
                    
                    let lineCheckTrac = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleTrac[index][i];
                    });
           
                    if (!lineCheckBy) isMatchBy = false;
                    if (!lineCheckTrac) isMatchTrac = false;
                });
                
                if (isMatchBy) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần bằng)";
                } else if (isMatchTrac) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần trắc)";
                } else {
                    return "Bài thơ không tuân theo luật thơ Đường";
                }
            } else if (lineWordCounts.every(count => count === 5) && totalLines === 4) {
                const ruleBy = [
                    ["B", "T", "B"],
                    ["T", "B", "T"],
                    ["T", "B", "T"],
                    ["B", "T", "B"]
                ];
                const ruleTrac = [
                    ["T", "B", "T"],
                    ["B", "T", "B"],
                    ["B", "T", "B"],
                    ["T", "B", "T"]
                ];
                
                let isMatchBy = true;
                let isMatchTrac = true;
                
                lines.forEach((line, index) => {
                    let words = line.trim().split(/\s+/);
                    let positionsToCheck = [1, 3];
           
                    let lineCheckBy = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleBy[index][i];
                    });
                    
                    let lineCheckTrac = positionsToCheck.every((pos, i) => {
                        if (pos >= words.length) return false;
           
                        let word = words[pos];
                        let mainVowels = word.split('').filter(char =>
                            'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(char)
                        );
           
                        let tone = mainVowels.some(vowel => 'áảãạắẳẵặấẩẫậéẻẽẹếểễệíỉĩịóỏõọốổỗộớởợỡúùủũụýỳỷỹỵứửữự'.includes(vowel)) ? "T" : "B";
                        return tone === ruleTrac[index][i];
                    });
           
                    if (!lineCheckBy) isMatchBy = false;
                    if (!lineCheckTrac) isMatchTrac = false;
                });
                
                if (isMatchBy) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần bằng)";
                } else if (isMatchTrac) {
                    return "Bài thơ trên thỏa mãn Đường luật (luật vần trắc)";
                } else {
                    return "Bài thơ không tuân theo luật thơ Đường";
                }
            }
            
            return null;
        }

        function determinePoemType(lines) {
            const lineWordCounts = lines.map(line => line.split(/\s+/).filter(word => word.trim() !== "").length);
            const totalLines = lines.length;
            
            let poemType = '';
            let reason = '';
            let link = '';

            if (lineWordCounts.every(count => count === 4)) {
                poemType = "thơ bốn chữ";
                reason = "Tất cả các dòng đều có 4 từ.";
                link = "https://sites.google.com/d/157wMz39hNOMUG90CfaDlPFyeGXgwQmud/p/1xH8yScX5yIFrJJD3Xfxo_5znSZR-alt4/edit";
            } else if (lineWordCounts.every(count => count === 5) && totalLines !== 4 && totalLines !== 8) {
                poemType = "thơ năm chữ";
                reason = "Tất cả các dòng đều có 5 từ.";
                link = "https://sites.google.com/d/1vjOkMcWDcfwasj7uNdo7Soz260kweM9t/p/1A2iKqRsaA-2y6ZxCQiy3H0ptagEjEw3-/edit";
            } else if (lineWordCounts.every(count => count === 6)) {
                poemType = "thơ sáu chữ";
                reason = "Tất cả các dòng đều có 6 từ.";
                link = "https://sites.google.com/d/1Jy8TB7pMaXtPPBnckid8FkaAQtjas-Ul/p/1f46o9Bt46EemtXaEqLU7rpuAJXOuiaxq/edit";
            } else if (lineWordCounts.every(count => count === 7) && totalLines !== 8 && totalLines !== 4) {
                poemType = "thơ bảy chữ";
                reason = "Tất cả các dòng đều có 7 từ.";
                link = "https://sites.google.com/d/1w_ieq9HwZiPvub6P8Ed27S1Io3ccR-qu/p/1j53fl-D6zs5xNZjgsYfLooESG6UNSA6o/edit";
            } else if (lineWordCounts.every(count => count === 8)) {
                poemType = "thơ tám chữ";
                reason = "Tất cả các dòng đều có 8 từ.";
                link = "https://sites.google.com/d/101GPt8qMIMbJKisOQls7VSgNS4sJnHkN/p/12Jzo7WH2tC_zthwOGAm4bMiQpOxmJrzr/edit";
            } else if (lineWordCounts.filter((count, index) => index % 2 === 0).every(count => count === 6) &&
                       lineWordCounts.filter((count, index) => index % 2 !== 0).every(count => count === 8)) {
                poemType = "thơ lục bát";
                reason = "Các dòng lẻ có 6 từ và các dòng chẵn có 8 từ.";
                link = "https://sites.google.com/d/1nyEJoi-e6ROC4tPFBzZQLy8d_mB25vhl/p/1zXi3KVyRn0KocfaXOaqnbIVJDjbuNNz1/edit";
            } else if (lineWordCounts[0] === 7 && lineWordCounts[1] === 7 && lineWordCounts[2] === 6 && lineWordCounts[3] === 8) {
                poemType = "thơ song thất lục bát";
                reason = "Dòng 1 có 7 từ, dòng 2 có 7 từ, dòng 3 có 6 từ và dòng 4 có 8 từ.";
                link = "https://sites.google.com/d/1rBuKQ4O7zQCia0ddqHsWDTLKeB1xZhyr/p/1rWjrFWyrwktd9FwrgC-56zC9yPRsP_Zt/edit";
            } else if (lineWordCounts.every(count => count === 7) && totalLines === 8) {
                poemType = "thơ thất ngôn bát cú";
                reason = "Tất cả các dòng đều có 7 từ và tổng số dòng là 8.";
                link = "https://sites.google.com/d/1n3KX2r7B8dKid99SZPbFlLA33HHRWg4V/p/1sL3M1WDcOCcQ_hWp-D1BV6VrW6rgQkBv/edit";
            } else if (lineWordCounts.every(count => count === 7) && totalLines === 4) {
                poemType = "thơ thất ngôn tứ tuyệt";
                reason = "Tất cả các dòng đều có 7 từ và tổng số dòng là 4.";
                link = "https://sites.google.com/d/1q-T_B1zL3OQw4_n6y6TYqwnCaEhDEBj6/p/15UDMnJtbDWJe2nNgBc9hB46IuqBJ4-XA/edit";
            } else if (lineWordCounts.every(count => count === 5) && totalLines === 4) {
                poemType = "thơ ngũ ngôn tứ tuyệt";
                reason = "Tất cả các dòng đều có 5 từ và tổng số dòng là 4.";
                link = "https://sites.google.com/d/1SzDcYd0SNTQIUc5hY4WiNPqfZ3XPLr4E/p/1asf_V6GEdTxPPO4AvU-cx1rS28QjD9Kx/edit";
            } else if (lineWordCounts.every(count => count === 5) && totalLines === 8) {
                poemType = "thơ ngũ ngôn bát cú";
                reason = "Tất cả các dòng đều có 5 từ và tổng số dòng là 8."; 
                link = "https://sites.google.com/d/1VE--6sIi1SSOKg87Vdk1Rfs4jfmesvqe/p/1-T_OVaq7_djFH0VRPxoDZjGGd8jQG8oy/edit";
            } else if (lineWordCounts.every(count => count === 7 || count === 6) && 
                       lineWordCounts.includes(7) && 
                       lineWordCounts.includes(6)) {
                poemType = "thơ thất ngôn xen lục ngôn";
                reason = "Bài thơ chủ yếu có 7 từ mỗi dòng, nhưng có một số dòng có 6 từ xen kẽ.";
                link = "https://sites.google.com/d/1aeQhnz1ZSlamkzjgQb28rgGdCPiuY75d/p/1tvdRIvpY5klXn--7i4L53BY9CTAI9YX7/edit";
            } else {
                poemType = "thơ tự do";
                reason = "Số từ của các dòng không theo quy luật của bất kì 1 thể thơ nào.";
                link = "https://sites.google.com/d/1GJq252v2Fi9hp-oknhlGuxMM1ksz4f2E/p/14bdR8c4joPxWbyzGaeXBZKJfWLPCRZv1/edit";
            }
            
            return { poemType, reason, link };
        }

        document.getElementById('inputText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeText();
            }
        });

        async function analyzeText() {
            const inputText = document.getElementById('inputText').value.trim();
            const resultDiv = document.getElementById('result');

            if (!inputText) {
                resultDiv.innerHTML = '<p class="text-red-500">Vui lòng nhập nội dung!</p>';
                return;
            }

            // Kiểm tra số từ
            const wordCount = countWords(inputText);
            if (wordCount < 4) {
                resultDiv.innerHTML = '<p class="text-red-500">Bạn phải nhập ít nhất 4 chữ trở lên!</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="text-gray-500">Đang phân tích...</p>';

            try {
                // Chỉ sử dụng AI để phân loại (đã bỏ phần verify bằng logic cứng)
                const typeResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_CONFIG.model}:generateContent?key=${GEMINI_CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Xác định nội dung sau thuộc loại: thơ, ca dao, tục ngữ, hay không phải thơ, ca dao, tục ngữ. Chỉ trả lời một trong bốn lựa chọn. Nội dung: "${inputText}"`
                            }]
                        }]
                    })
                });

                if (!typeResponse.ok) throw new Error('Lỗi khi xác định loại văn bản');
                const typeData = await typeResponse.json();
                let textType = typeData.candidates[0].content.parts[0].text.trim().toLowerCase();

                resultDiv.innerHTML = `
                    <div class="border-l-4 border-blue-500 pl-4 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-tags mr-2"></i> Kết quả phân loại:
                        </h3>
                        <p class="text-gray-600 font-bold">${textType.charAt(0).toUpperCase() + textType.slice(1)}</p>
                    </div>`;

                if (textType === 'thơ') {
                    const lines = inputText.split(/\n+/).filter(line => line.trim() !== '');
                    
                    const titleResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_CONFIG.model}:generateContent?key=${GEMINI_CONFIG.apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `Xác định tên tác phẩm của bài thơ sau dựa trên nội dung hoặc đặc điểm văn học. Chỉ trả về tên tác phẩm hoặc "Không xác định được" nếu không nhận diện được. Nội dung: "${inputText}"`
                                }]
                            }]
                        })
                    });
                    if (!titleResponse.ok) throw new Error('Lỗi khi xác định tên tác phẩm');
                    const titleData = await titleResponse.json();
                    let titleResult = titleData.candidates[0].content.parts[0].text.trim();

                    titleResult = verifyAIOutput('poemTitle', inputText, titleResult);

                    resultDiv.innerHTML += `
                        <div class="border-l-4 border-green-500 pl-4 mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-book mr-2"></i> Tên tác phẩm:
                            </h3>
                            <p class="text-gray-600 font-bold">${titleResult}</p>
                        </div>`;

                    const { poemType, reason, link } = determinePoemType(lines);
                    
                    resultDiv.innerHTML += `
                        <div class="border-l-4 border-purple-500 pl-4 mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-ruler-combined mr-2"></i> Thể thơ:
                            </h3>
                            <p class="text-gray-600 font-bold">${poemType}</p>
                            <p class="text-gray-600 mt-1">${reason}</p>
                            ${link ? `<p class="text-gray-600 mt-1">Tìm hiểu thêm: <a href="${link}" target="_blank" class="text-blue-600 hover:underline">${poemType}</a></p>` : ''}
                        </div>`;

                    analyzeRhymeAndTone(inputText);

                    await Promise.all([
                        fetchAnalysis(
                            `Phân tích nội dung bài thơ với các đầu mục: **Ý nghĩa**, **Cảm xúc**, **Chủ đề chính**.`,
                            'Phân tích nội dung',
                            'border-purple-500',
                            'fas fa-scroll'
                        ),
                        fetchAnalysis(
                            `Phân tích nghệ thuật bài thơ với các đầu mục: **Biện pháp tu từ**, **Nhịp điệu**, **Hình ảnh**, **Cách gieo vần**.`,
                            'Phân tích nghệ thuật',
                            'border-orange-500',
                            'fas fa-paint-brush'
                        )
                    ]);
                } else if (textType === 'ca dao' || textType === 'tục ngữ') {
                    await Promise.all([
                        fetchAnalysis(
                            `Phân tích ${textType} với các đầu mục: **Nghĩa đen**, **Nghĩa bóng**, **Hình ảnh và từ ngữ**, **Ý nghĩa biểu tượng**.`,
                            'Nghĩa đen và nghĩa bóng',
                            'border-blue-500',
                            'fas fa-lightbulb'
                        ),
                        fetchAnalysis(
                            `Phân tích nội dung tư tưởng của ${textType} với các đầu mục: **Bài học**, **Tình cảm – cảm xúc**, **Thái độ**.`,
                            'Nội dung tư tưởng',
                            'border-green-500',
                            'fas fa-brain'
                        ),
                        fetchAnalysis(
                            `Phân tích biện pháp nghệ thuật của ${textType} với các đầu mục: **Hình ảnh dân dã**, **Biện pháp tu từ**, **Nhịp điệu**, **Âm điệu**, **Từ láy**, **Cách gieo vần**, **Cấu trúc lặp**.`,
                            'Biện pháp nghệ thuật',
                            'border-purple-500',
                            'fas fa-paint-brush'
                        ),
                        fetchAnalysis(
                            `Phân tích giá trị của ${textType} với các đầu mục: **Giá trị nhân văn**, **Giá trị nhân đạo**, **Giá trị giáo dục**.`,
                            'Giá trị',
                            'border-orange-500',
                            'fas fa-star'
                        )
                    ]);
                } else {
                    resultDiv.innerHTML += `<p class="text-gray-600">Không có phân tích chi tiết vì nội dung không phải thơ, ca dao, hay tục ngữ.</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">Đã xảy ra lỗi: ${error.message}</p>`;
            }
        }

        async function fetchAnalysis(prompt, sectionTitle, colorClass, iconClass) {
            const inputText = document.getElementById('inputText').value.trim();
            const resultDiv = document.getElementById('result');
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_CONFIG.model}:generateContent?key=${GEMINI_CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `${prompt} Trả lời ngắn gọn, súc tích, mỗi ý xuống dòng. Chỉ sử dụng ** để in đậm các đầu mục (ví dụ: **Ý nghĩa**, **Cảm xúc**), không in đậm hoặc in nghiêng nội dung chi tiết trừ khi cần nhấn mạnh ý nghĩa cụ thể. Nội dung: "${inputText}"`
                            }]
                        }]
                    })
                });
                if (!response.ok) throw new Error(`Lỗi khi phân tích ${sectionTitle}`);
                const data = await response.json();
                let result = parseMarkdown(data.candidates[0].content.parts[0].text.trim());

                const analysisType = sectionTitle.includes('nội dung') ? 'contentAnalysis' : 
                                    sectionTitle.includes('nghệ thuật') ? 'artisticAnalysis' : null;
                if (analysisType) {
                    result = verifyAIOutput(analysisType, inputText, result);
                }

                resultDiv.innerHTML += `
                    <div class="border-l-4 ${colorClass} pl-4 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="${iconClass} mr-2"></i> ${sectionTitle}:
                        </h3>
                        <p class="text-gray-600">${result}</p>
                    </div>`;
            } catch (error) {
                resultDiv.innerHTML += `<p class="text-red-500 mt-4">Lỗi ${sectionTitle}: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
